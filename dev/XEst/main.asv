%% XEst main 

%% init
close all; clear; clc; addpath(genpath('./'));

cfg   = config_class(test_ID  = 'test_001', ... % --->> config on the fly
                     btype    = 'KITTI');
dlog  = dlogger_class(); dlog.load_cfg(cfg); 
quest = quest_class(); quest.load_cfg(cfg); 
vest  = vest_class(); vest.load_cfg(cfg); 
qekf  = qekf_handler_class(); qekf.load_cfg(cfg); 
rpt   = report_class(); rpt.load_cfg(cfg);
%% todo: keep track features for x number of frames

%% run 
cntr  = 0;  
for frame_idx = cfg.dat.keyFrames % --->> iter keyframes 
  cntr      = cntr+1;
  TQVW_sols = quest.get_pose(frame_idx, cfg.dat); % get pose
  TQVW_sols = vest.get_vel(cfg.dat.matches, TQVW_sols); % get velocity
  st_sols   = qekf.run_filter(TQVW_sols); % run filter
  dlog.log_state(cntr, frame_idx, TQVW_sols, st_sols);
end 

%% results
quest_res   = quest.get_res(cfg, dlog);
vest_res    = vest.get_res(cfg, dlog);
qekf_res    = qekf.get_res(cfg, dlog);
disp("end of process...");

%% report
rpt.load_res(quest_res, vest_res, qekf_res);
rpt.generate(); 

import mlreportgen.report.* 
import mlreportgen.dom.* 

rpt = Report(rpt_title,'html'); 
tp = TitlePage; 
tp.Title = 'XEst'; 
tp.Subtitle = 'Columns, Rows, Diagonals: All Equal Sums'; 
tp.Author = 'Bardia Mojra'; 
append(rpt,tp); 
append(rpt,TableOfContents); 


% create the document object
doc_obj = Document('MATLAB_test_report','pdf');


% Create Paragraph objects for table data
tableData = {'a','b';'5','P'};
for k = 1:numel(tableData)
    p = Paragraph(tableData{k});
    p.FontFamilyName = 'Calibri';
    tableData{k} = p;
end
% table
tableObj = Table ( tableData ) ;
tableObj.Width = '30pt';
tableObj.Border = 'none';
tableObj.TableEntriesStyle = {Height('20pt')};
% append
append ( doc_obj , tableObj ) ;
% close document
close(doc_obj);
% display
rptview(doc_obj);