%% XEst main 
% Summary of example objective
%

%% init
% warning('off','all'); % turn off all warnings!
close all; clear; clc 
addpath(genpath('./'));

% config - datasets handled in cfg
cfg = config_class(test_ID   =   'quest_unit_test');
cfg = init(cfg);

dlog = dlog_class();
dlog = dlog.load_cfg(cfg); % overwrite default settings 

quest = quest_class();
quest = quest.load_cfg(cfg); 

vest = vest_class();
% vest = vest.load_cfg(vest, cfg); 

% qekf = qekf_class();
% qekf = qekf.load_cfg(qekf, cfg); 


%% run 
benchName = [];
for bnch = length(cfg.benchmarks)
  benchName = cfg.benchmarks(bnch);
  int idx  = 0; % test index
  for frame_idx = cfg.dats.keyFrames
    idx = idx+1;
  
    [quest,T,Q] = quest.get_pose(frame_idx, dat, cfg);  
    [vest, V, W] = vest.get_vel(frame_idx, quest.matches); % get velocity
    vest.check_w_QuEst(W, Q);
  %   x_TVWQ = QEKF(i,TQ,V,W);
  
    dlog.log_state(benchName, idx, frame_idx, T, Q, V, W);
    
    dlog.datidx_hist(idx,1) = idx;
    dlog.kF_hist(idx,:) =  frame_idx;
    dlog.T_hist(idx,:)  =  T;
    dlog.Q_hist(idx,:)  =  Q;
    dlog.V_hist(idx,:)  =  V;
    dlog.W_hist(idx,:) =  W;
      
    %   Q_VEst = exp_map(W);
  %    if isequal(Q,Q_VEst)
  %     disp('QuEst and VEst rotation estimates match!');
  %    end 
  
  end % end of for frame_idx = cfg.dats.keyFrames
end % bnch = length(cfg.benchmarks)

%% post-processing 

quest_res = quest.get_res(dlog);
vest_res = vest.get_res(dlog);
qekf_res = qekf.get_res(dlog);

